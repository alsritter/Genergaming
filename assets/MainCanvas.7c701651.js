var t=Object.defineProperty,e=Object.defineProperties,i=Object.getOwnPropertyDescriptors,s=Object.getOwnPropertySymbols,a=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable,o=(e,i,s)=>i in e?t(e,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[i]=s,r=("undefined"!=typeof require&&require,(t,e,i)=>(o(t,"symbol"!=typeof e?e+"":e,i),i));import{C as h,L as l,a as c,u as d,b as y,c as x,I as u,T as g,P as f,d as p,e as v}from"./index.9c72cbe0.js";import{n as w,d as C,h as m,l as S,z as P,p as b,c as T,i as D,o as A,s as I,w as O,f as E,G as R}from"./vendor.36455290.js";function M(t,e,i,s,a,n,o,r,l,c,d,y){if(null==y)return;const x=h(o,r,l,c,d);x.x>a||x.x+o<0||x.y>n||x.y+o<0||(e.clearRect(x.x,x.y,o,o),i.clearRect(x.x,x.y,o,o),s.clearRect(x.x,x.y,o,o),t.fillStyle=y.color,null!=y.image&&t.drawImage(y.image,x.x,x.y,o,o),t.fillRect(x.x,x.y,o,o))}function k(t,e,i){t.clearRect(0,0,e,i)}function L(t,e,i,s,a,n,o){const r=h(o,s,a,n.x,n.y);t.clearRect(r.x,r.y,o,o),e.clearRect(r.x,r.y,o,o),i.clearRect(r.x,r.y,o,o)}function z(t,e,i,s,a){const n=h(a,e,i,s.x,s.y);t.clearRect(n.x,n.y,a,a)}var _={drawGrid:function(t,e,i,s,a,n,o,r){k(t,e,i);const h=e/s,l=i/s;t.setLineDash([1,2]),t.strokeStyle="#2a2a2a",t.fillStyle="#2a2a2a",t.lineWidth=1;const c=a/e*h,d=n/i*l;for(let y=0;y<h;y++)t.beginPath(),o&&(t.moveTo(s*y+a%s,0),t.lineTo(s*y+a%s,i),t.stroke()),r&&(t.font=.6*s+"px serif",t.fillText(Math.ceil(y-c)+"",s*y-.5+a%s,n+s/2,s));for(let y=0;y<l;y++)t.beginPath(),o&&(t.moveTo(0,s*y+n%s),t.lineTo(e,s*y+n%s),t.stroke()),r&&(t.font=.6*s+"px serif",t.fillText(-Math.ceil(y-d)+"",a,s*y-.5+s/2+n%s,s));r&&(t.beginPath(),t.setLineDash([]),t.lineWidth=2,t.strokeStyle="#161a1d",t.moveTo(0,n),t.lineTo(e,n),t.moveTo(a,0),t.lineTo(a,i),t.stroke())},clearAllCanvas:k,drawSingleItem:M,drawAllItem:function(t,e,i,s,a,n,o,r,h,c){k(t,r,h),k(e,r,h),k(i,r,h);for(const d of c)switch(d.layer){case l.FRONT:if(!s.frontShow)break;M(t,t,e,i,r,h,a,n,o,d.point.x,d.point.y,d.data);break;case l.MIDDLE:if(!s.middleShow)break;M(e,t,e,i,r,h,a,n,o,d.point.x,d.point.y,d.data);break;case l.BACKGROUND:if(!s.backgroundShow)break;M(i,t,e,i,r,h,a,n,o,d.point.x,d.point.y,d.data)}},clearCanvasPoint:L,drawAreaItem:function(t,e,i,s,a,n,o,r,h,l,c,d){let y,x,u,g;l.x>c.x?(y=l.x,x=c.x):(y=c.x,x=l.x),l.y>c.y?(u=l.y,g=c.y):(u=c.y,g=l.y);for(let f=x;f<=y;f++)for(let l=g;l<=u;l++)M(t,e,i,s,a,n,o,r,h,f,l,d)},clearAreaItem:function(t,e,i,s,a,n,o,r){let h,l,c,d;o.x>r.x?(h=o.x,l=r.x):(h=r.x,l=o.x),o.y>r.y?(c=o.y,d=r.y):(c=r.y,d=o.y);for(let y=l;y<=h;y++)for(let o=d;o<=c;o++)L(t,e,i,a,n,{x:y,y:o},s)},clearSingleLayerAreaItem:function(t,e,i,s,a,n){let o,r,h,l;a.x>n.x?(o=a.x,r=n.x):(o=n.x,r=a.x),a.y>n.y?(h=a.y,l=n.y):(h=n.y,l=a.y);for(let c=r;c<=o;c++)for(let a=l;a<=h;a++)z(t,i,s,{x:c,y:a},e)},clearSingleLayerCanvasPoint:z,drawSingleItemInSingleLayer:function(t,e,i,s,a,n,o,r,l){if(null==l)return;const c=h(s,a,n,o,r);c.x>e||c.x+s<0||c.y>i||c.y+s<0||(t.clearRect(c.x,c.y,s,s),t.fillStyle=l.color,null!=l.image&&t.drawImage(l.image,c.x,c.y,s,s),t.fillRect(c.x,c.y,s,s))},drawSingleColorInSingleLayer:function(t,e,i,s,a,n,o){if(null==o)return;const r=h(s,a.x,a.y,n.x,n.y);r.x>e||r.x+s<0||r.y>i||r.y+s<0||(t.clearRect(r.x,r.y,s,s),t.fillStyle=o,t.fillRect(r.x,r.y,s,s))}};function N(t,e,i,s,a,n,o){if(null==o)return;const r=h(e,i,s,a,n);t.clearRect(r.x,r.y,o.width*e,o.height*e),t.fillStyle="#8c40405c",null!=o.image&&t.drawImage(o.image,r.x,r.y,o.width*e,o.height*e),t.fillRect(r.x,r.y,o.width*e,o.height*e)}var B={drawBlockBox:(t,e,i,s,a,n)=>{const o=e*c.BLOCK_SIZE,r=c.BLOCK_SIZE,l=h(e,i,s,a-(a>0?r-1:-r),n-(n>0?r-1:-r)),d=o*(a>0?1:-1),y=o*(n>0?1:-1);t.beginPath(),t.moveTo(l.x,l.y),t.lineTo(l.x+d,l.y),t.moveTo(l.x,l.y),t.lineTo(l.x,l.y+y),t.moveTo(l.x+d,l.y+y),t.lineTo(l.x,l.y+y),t.moveTo(l.x+d,l.y+y),t.lineTo(l.x+d,l.y),t.stroke()},drawSinglePrefab:N,drawAllPrefab:function(t,e,i,s,a,n,o){if(k(t,e,i),o)for(const r of o)N(t,s,a,n,r.point.x,r.point.y,r.data)}};class G{constructor(){r(this,"timer"),r(this,"stop",!1),r(this,"death",!1)}use(t,e,i=!1){let s=!0;const a=this;return(...n)=>{if(this.death)t.apply(this,n);else{if(!this.stop)return i?(t.apply(this,n),void(i=!1)):void(s&&(s=!1,a.timer=window.setTimeout((()=>{t.apply(this,n),s=!0}),e)));t.apply(this,n)}}}destroy(){this.death=!0,this.stop=!0,this.timer&&(clearTimeout(this.timer),this.timer=void 0)}open(){this.death||(this.stop=!1)}close(){this.stop=!0}}class U{constructor(t){r(this,"store"),r(this,"canvasDOM"),r(this,"brushState"),r(this,"dragCanvas",(()=>{let t={x:0,y:0};this.canvasDOM.onmousedown=e=>{t=x.windowToCanvas(this.canvasDOM,e.clientX,e.clientY),this.store.action.canvasModifyDragState(!0)};const e=new G,i=e.use((e=>{const i=x.windowToCanvas(this.canvasDOM,e.clientX,e.clientY);this.store.action.canvasInit_X(this.store.state.initPoint.x+i.x-t.x),this.store.action.canvasInit_Y(this.store.state.initPoint.y+i.y-t.y),t=x.windowToCanvas(this.canvasDOM,e.clientX,e.clientY),y.emit("refreshCanvas")}),10);e.open(),this.canvasDOM.onmouseup=()=>{e.destroy(),this.store.action.canvasModifyDragState(!1)},this.canvasDOM.onmousemove=t=>{this.store.state.dragging&&i(t)},this.canvasDOM.onmouseout=()=>{e.destroy(),this.store.action.canvasModifyDragState(!1)}})),r(this,"initCanvasEvent",(()=>{this.canvasDOM.onmousedown=null,this.canvasDOM.onmouseup=null,this.canvasDOM.onmousemove=null,this.canvasDOM.onmouseout=null,this.drawCanvas(),this.store.action.canvasModifyDragState(!1)})),r(this,"drawCanvas",(()=>{if(y.emit("brushClear"),this.store.state.itemType==u.TILE)switch(this.store.state.currentTool){case g.PEN:this.click("pen",!0,"eraser");break;case g.PIPETA:this.click("pipette",!1);break;case g.ERASER:this.click("eraser",!1);break;case g.AREA_PEN:this.drag("areaPen","areaEraser","pen","eraser");break;case g.AREA_ERASER:this.drag("areaEraser");break;case g.START:this.click("startPoint",!1);break;default:this.click("pen",!0,"eraser")}else switch(this.store.state.currentPrefabTool){case f.DRAW:this.click("prefabDraw",!0,"prefabDelete");break;case f.DELETE:this.click("prefabDelete",!1)}})),this.store=d(),this.canvasDOM=t,this.brushState=new F(this.canvasDOM,this.store),this.initCanvasEvent(),w((()=>this.store.getters.isAlt()),(t=>{t?this.dragCanvas():this.initCanvasEvent()})),y.on("init",(()=>{this.initCanvasEvent()}))}click(t,e,i=""){e&&this.brushState.open(),this.canvasDOM.onmousedown=e=>{this.brushState.close();const s=x.pixToCoordinate(this.canvasDOM,this.store.state.canvasSize,this.store.state.initPoint.x,this.store.state.initPoint.y,e.clientX,e.clientY);1==e.buttons&&y.emit(t,s),i&&2==e.buttons&&y.emit(i,s)},this.canvasDOM.onmouseup=()=>{e&&this.brushState.open()},this.canvasDOM.onmouseout=()=>{e&&this.brushState.open()}}drag(t,e="",i="",s=""){let a=!1,n={x:0,y:0},o={x:0,y:0},r={x:0,y:0};const h=new G,l=h.use((i=>{r=x.pixToCoordinate(this.canvasDOM,this.store.state.canvasSize,this.store.state.initPoint.x,this.store.state.initPoint.y,i.clientX,i.clientY),o.x==r.x&&o.y==r.y||(o=r,1!=i.buttons?e&&2==i.buttons&&y.emit(e,{start:n,end:o}):y.emit(t,{start:n,end:o}))}),10);h.open(),this.canvasDOM.onmousedown=t=>{a=!0,n=x.pixToCoordinate(this.canvasDOM,this.store.state.canvasSize,this.store.state.initPoint.x,this.store.state.initPoint.y,t.clientX,t.clientY),o=n,i&&1==t.buttons&&y.emit(i,n),s&&2==t.buttons&&y.emit(s,n)},this.canvasDOM.onmouseup=()=>{h.destroy(),a=!1},this.canvasDOM.onmouseout=()=>{h.destroy(),a=!1},this.canvasDOM.onmousemove=t=>{a&&l(t)}}}class F{constructor(t,e){r(this,"store"),r(this,"canvasDOM"),r(this,"throttle"),r(this,"moveFun"),r(this,"endPoint"),r(this,"deffPoint"),this.canvasDOM=t,this.store=e,this.throttle=new G,this.endPoint={x:0,y:0},this.deffPoint={x:0,y:0},this.moveFun=this.throttle.use((t=>{this.deffPoint=x.pixToCoordinate(this.canvasDOM,this.store.state.canvasSize,this.store.state.initPoint.x,this.store.state.initPoint.y,t.clientX,t.clientY),this.endPoint.x==this.deffPoint.x&&this.endPoint.y==this.deffPoint.y||(this.endPoint=this.deffPoint,y.emit("brushMove",this.deffPoint))}),10)}open(){this.throttle.open(),this.canvasDOM.onmousemove=t=>{this.moveFun(t)}}close(){this.throttle.close(),this.canvasDOM.onmousemove=null,this.endPoint={x:0,y:0},this.deffPoint={x:0,y:0}}}class V{constructor(t,e,i,s,a,n,o){r(this,"width"),r(this,"height"),r(this,"store"),r(this,"gridElement"),r(this,"brushCtx"),r(this,"frontCtx"),r(this,"middleCtx"),r(this,"backgroundCtx"),r(this,"prefabCtx"),r(this,"specialCtx"),this.width=c.CANVAS_WIDTH,this.height=c.CANVAS_HEIGHT,this.store=d(),this.gridElement=t,this.brushCtx=e,this.frontCtx=i,this.middleCtx=s,this.backgroundCtx=a,this.prefabCtx=n,this.specialCtx=o,this.initDraw(),this.handleDrawTileEvent(),this.handleRefreshCanvas()}initDraw(){const t=this.gridElement.getContext("2d");_.drawGrid(t,this.width,this.height,c.DEFAULT_SIZE,this.store.state.initPoint.x,this.store.state.initPoint.y,this.store.state.showGrid,this.store.state.showAxis)}handleDrawTileEvent(){y.on("startPoint",(t=>{const e=t,i=this.store.state.startPoint;_.clearSingleLayerCanvasPoint(this.specialCtx,this.store.state.initPoint.x,this.store.state.initPoint.y,i,this.store.state.canvasSize),this.store.action.mapSetStartPoint(e),_.drawSingleColorInSingleLayer(this.specialCtx,this.width,this.height,this.store.state.canvasSize,this.store.state.initPoint,e,c.Start_Point_Color)})),y.on("pen",(t=>{const e=this.store.state.currentLayer;if(!this.store.getters.currentLayerIsDisplayed(e))return;const i=t,s=this.store.action.mapAddTile(i);switch(e){case l.FRONT:this.drawTile(s,this.frontCtx);break;case l.MIDDLE:case l.BACKGROUND:this.drawTile(s,this.backgroundCtx)}})),y.on("pipette",(t=>{const e=t,i=this.store.getters.getTileByPoint(e);i&&this.store.action.currentTileModify({isCollect:!0,spriteId:i.data.tileSpriteId,key:i.data.key,path:i.data.url,name:"",desc:"",image:i.data.image})})),y.on("eraser",(t=>{const e=this.store.state.currentLayer;if(!this.store.getters.currentLayerIsDisplayed(e))return;const i=t;this.store.action.mapDeleteTile(i),this.deleteTile(i)})),y.on("areaPen",(t=>{const e=this.store.state.currentLayer;if(!this.store.getters.currentLayerIsDisplayed(e))return;const i=t.start,s=t.end,a=this.store.action.mapAddAreaTile(i,s);switch(e){case l.FRONT:this.drawAreaTile(a,i,s,this.frontCtx);break;case l.MIDDLE:case l.BACKGROUND:this.drawAreaTile(a,i,s,this.backgroundCtx)}})),y.on("areaEraser",(t=>{const e=this.store.state.currentLayer;if(!this.store.getters.currentLayerIsDisplayed(e))return;const i=t.start,s=t.end;this.store.action.mapDeleteAreaTile(i,s),this.deleteAreaTile(i,s)})),y.on("prefabDraw",(t=>{const e=t;if(null==this.store.getters.getPrefabByPoint(e)){const t=this.store.action.mapAddPrefab(e);if(!t)return;B.drawSinglePrefab(this.prefabCtx,this.store.state.canvasSize,this.store.state.initPoint.x,this.store.state.initPoint.y,t.point.x,t.point.y,t.data)}})),y.on("prefabDelete",(t=>{const e=t,i=this.store.action.mapDeletePrefab(e);i&&this.deleteSingleAreaTile(i.point,{x:i.point.x+i.data.width-1,y:i.point.y-i.data.height+1},this.prefabCtx)}));const t={type:u.TILE,canvasSize:0,initPoint:{x:0,y:0},point:{x:-10,y:-10},prefab:new p("",0,0,null),tile:new v("",l.FRONT,"","")};y.on("brushClear",(()=>{t.type==u.TILE?this.deleteSingleTile(t.point,this.brushCtx):this.deleteSingleAreaTile(t.point,{x:t.point.x+t.prefab.width-1,y:t.point.y-t.prefab.height+1},this.brushCtx)})),y.on("brushMove",(e=>{const i=e;t.type==u.TILE?this.deleteSingleTile(t.point,this.brushCtx):this.deleteSingleAreaTile(t.point,{x:t.point.x+t.prefab.width-1,y:t.point.y-t.prefab.height+1},this.brushCtx),t.type=this.store.state.itemType,t.canvasSize=this.store.state.canvasSize,t.initPoint=this.store.state.initPoint,t.point=i,t.prefab=this.store.getters.getCurrentPrefabData(),t.tile=this.store.getters.getCurrentTileData(),this.store.state.itemType==u.TILE?this.drawTileInSingleLayer(t.point,t.tile,this.brushCtx):B.drawSinglePrefab(this.brushCtx,t.canvasSize,t.initPoint.x,t.initPoint.y,t.point.x,t.point.y,t.prefab)}))}drawTile(t,e){_.drawSingleItem(e,this.frontCtx,this.middleCtx,this.backgroundCtx,this.width,this.height,this.store.state.canvasSize,this.store.state.initPoint.x,this.store.state.initPoint.y,t.point.x,t.point.y,t.data)}drawTileInSingleLayer(t,e,i){_.drawSingleItemInSingleLayer(i,this.width,this.height,this.store.state.canvasSize,this.store.state.initPoint.x,this.store.state.initPoint.y,t.x,t.y,e)}drawAreaTile(t,e,i,s){_.drawAreaItem(s,this.frontCtx,this.middleCtx,this.backgroundCtx,this.width,this.height,this.store.state.canvasSize,this.store.state.initPoint.x,this.store.state.initPoint.y,e,i,t)}deleteTile(t){_.clearCanvasPoint(this.frontCtx,this.middleCtx,this.backgroundCtx,this.store.state.initPoint.x,this.store.state.initPoint.y,t,this.store.state.canvasSize)}deleteSingleTile(t,e){_.clearSingleLayerCanvasPoint(e,this.store.state.initPoint.x,this.store.state.initPoint.y,t,this.store.state.canvasSize)}deleteAreaTile(t,e){_.clearAreaItem(this.frontCtx,this.middleCtx,this.backgroundCtx,this.store.state.canvasSize,this.store.state.initPoint.x,this.store.state.initPoint.y,t,e)}deleteSingleAreaTile(t,e,i){_.clearSingleLayerAreaItem(i,this.store.state.canvasSize,this.store.state.initPoint.x,this.store.state.initPoint.y,t,e)}handleRefreshCanvas(){y.on("refreshCanvas",(()=>{this.addTask()}))}addTask(){const t=new Array;t.push({data:{frontCtx:this.frontCtx,middleCtx:this.middleCtx,backgroundCtx:this.backgroundCtx,size:this.store.state.canvasSize,initX:this.store.state.initPoint.x,initY:this.store.state.initPoint.y,width:this.width,height:this.height},priority:1}),((t,e,i)=>{const s=t;s.length<3&&setTimeout((function a(){const n=+new Date;do{const t=s.shift();e(t),s.length>3&&(s.splice(0,s.length-3),s.sort(((t,e)=>t.priority-e.priority)))}while(s.length&&+new Date-n<50);s.length>0?setTimeout(a,25):i(t)}))})(t,(t=>{if(null==t)return;const e=x.canvasPixToCoordinate(this.store.state.canvasSize,this.store.state.initPoint.x,this.store.state.initPoint.y,-1*this.store.state.canvasSize,-1*this.store.state.canvasSize),i=x.canvasPixToCoordinate(this.store.state.canvasSize,this.store.state.initPoint.x,this.store.state.initPoint.y,this.width+1*this.store.state.canvasSize,this.height+1*this.store.state.canvasSize),s=this.store.getters.getTileRange(e,i),a=this.gridElement.getContext("2d");if(_.drawGrid(a,this.width,this.height,this.store.state.canvasSize,this.store.state.initPoint.x,this.store.state.initPoint.y,this.store.state.showGrid,this.store.state.showAxis),_.drawAllItem(t.data.frontCtx,t.data.middleCtx,t.data.backgroundCtx,this.store.state.displayLayers,t.data.size,t.data.initX,t.data.initY,t.data.width,t.data.height,s),_.clearAllCanvas(this.prefabCtx,this.width,this.height),_.clearAllCanvas(this.brushCtx,this.width,this.height),_.clearAllCanvas(this.specialCtx,this.width,this.height),_.drawSingleColorInSingleLayer(this.specialCtx,this.width,this.height,this.store.state.canvasSize,this.store.state.initPoint,this.store.state.startPoint,c.Start_Point_Color),this.store.state.displayLayers.prefabShow){const t=this.store.getters.getPrefabRange(e,i);if(!t)return;B.drawAllPrefab(this.prefabCtx,this.width,this.height,this.store.state.canvasSize,this.store.state.initPoint.x,this.store.state.initPoint.y,t)}}),(()=>{}))}}var Y=C({setup(){const t=d(),r=m(null),h=m(null),x=m(null),u=m(null),g={[l.FRONT]:m(null),[l.MIDDLE]:m(null),[l.BACKGROUND]:m(null)},f=c.CANVAS_WIDTH,p=c.CANVAS_HEIGHT,v=S((()=>t.state.bgUrl));return P((()=>{const t=r.value,e=g.FRONT.value,i=g.MIDDLE.value,s=g.BACKGROUND.value,a=h.value,n=x.value,o=u.value;t.getContext("2d");const l=e.getContext("2d"),c=i.getContext("2d"),d=s.getContext("2d"),y=a.getContext("2d"),f=n.getContext("2d"),p=o.getContext("2d");f.globalAlpha=.5,new U(t),new V(t,f,l,c,d,y,p)})),w=((t,e)=>{for(var i in e||(e={}))a.call(e,i)&&o(t,i,e[i]);if(s)for(var i of s(e))n.call(e,i)&&o(t,i,e[i]);return t})({},g),e(w,i({GRID_CANVAS:r,PREFAB_CANVAS:h,SPECIAL_CANVAS:u,BRUSH_CANVAS:x,width:f,height:p,scrollBarWheel:function(e){if(null==e.deltaY)return;const i=t.state.canvasSize;if(e.deltaY<0){if(i>c.MAX_SIZE)return;t.action.canvasUpdateSize(i+1)}else if(e.deltaY>0){if(i<c.MIN_SIZE)return;t.action.canvasUpdateSize(i-1)}else console.error("Mouse wheel zooming in and out status acquisition failed!");y.emit("refreshCanvas")},bgUrl:v}));var w}});b("data-v-bfca6e28");const X={class:"map__container"},H=["src","width","height"],K=["width","height"],W=["width","height"],j=["width","height"],Z=["width","height"],q=["width","height"],J=["width","height"],Q=["width","height"];T(),Y.render=function(t,e,i,s,a,n){const o=D("el-card");return A(),I(o,{shadow:"always"},{default:O((()=>[E("div",X,[E("img",{class:"bg_img",src:t.bgUrl,width:t.width,height:t.height},null,8,H),E("canvas",{id:"GRID_CANVAS",ref:"GRID_CANVAS",class:"map",width:t.width,height:t.height,onWheel:e[0]||(e[0]=R(((...e)=>t.scrollBarWheel&&t.scrollBarWheel(...e)),["prevent"]))},null,40,K),E("canvas",{id:"FRONT",ref:"FRONT",class:"map",width:t.width,height:t.height},null,8,W),E("canvas",{id:"MIDDLE",ref:"MIDDLE",class:"map",width:t.width,height:t.height},null,8,j),E("canvas",{id:"BACKGROUND",ref:"BACKGROUND",class:"map",width:t.width,height:t.height},null,8,Z),E("canvas",{id:"PREFAB",ref:"PREFAB_CANVAS",class:"map",width:t.width,height:t.height},null,8,q),E("canvas",{id:"BRUSH",ref:"BRUSH_CANVAS",class:"map",width:t.width,height:t.height},null,8,J),E("canvas",{id:"SPECIAL",ref:"SPECIAL_CANVAS",class:"map",width:t.width,height:t.height},null,8,Q)])])),_:1})},Y.__scopeId="data-v-bfca6e28";export{Y as default};
